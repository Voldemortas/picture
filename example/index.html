<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Imager Example</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      .colorName {
        display: inline-block;
        min-width: 50px;
      }
      .block {
        display: inline-block;
        border: brown dashed 1px;
        margin: 2px;
      }
    </style>
    <script
      src="https://unpkg.com/typescript@latest/lib/typescript.js"
    ></script>
    <script>
      let exports = {}
      async function importPicture() {
        const file = await (await fetch('../lib/Picture.ts')).text()
        const blobUrl = URL.createObjectURL(
          new Blob([ts.transpile(file)], {
            type: 'application/javascript',
          }),
        )

        await import(blobUrl)
        return exports
      }
    </script>
  </head>
  <body>
    <div style="display: flex">
      <div>
        <img
          src="https://picsum.photos/400/400"
          crossorigin="anonymous"
          id="image"
        />
      </div>&nbsp;
      <div>
        <canvas
          width="400"
          height="400"
          id="canvas"
        ></canvas>
      </div>
    </div>
    <br />
    <div style="display: flex">
      <div class="block">
        <button id="reset">Reset image</button>
      </div>
      <div class="block">
        <button id="grayscale">Grayscale</button>
        <textarea
          id="grayscaleArea"
          style='display: block; height: 66px; width: 300px; font-family: "Courier New", Courier, monospace; font-size: 13px'
        >[0.2125, 0.7154, 0.0721]</textarea>
      </div>
      <div class="block">
        <button id="manipulate">Manipulate channels</button>
        <textarea
          id="manipulateArea"
          style='display: block; height: 66px; width: 300px; font-family: "Courier New", Courier, monospace; font-size: 13px'
        >([r, g, b]) => [1/4 * r + 127, g, b * 0.9]</textarea>
      </div>
      <div class="block">
        <button id="binary">Reset+grayscale+binarise</button><br />
        <button id="binary2">Binarise current image</button><br />
      </div>
      <div class="block">
        <button id="group">Group colours</button><textarea
          id="groupArea"
          style='display: block; height: 66px; width: 300px; font-family: "Courier New", Courier, monospace; font-size: 13px'
        >[1, 2, 1]</textarea>
      </div>
      <div class="block">
        <button id="convolve">Convolve, preserve edges</button>
        <button id="convolve2">Convolve, update edges</button><textarea
          id="convolveArea"
          style='display: block; height: 66px; width: 300px; font-family: "Courier New", Courier, monospace; font-size: 13px'
        >Kernel.unsharpen</textarea>
      </div>
    </div>

    <script type="module">
      const { default: Picture, Pixel, Kernel } = await importPicture()
      const img = document.getElementById('image')
      const canvas = document.getElementById('canvas')
      const ctx = canvas.getContext('2d')

      await initImage()

      async function initImage() {
        return new Promise((resolve) => {
          img.onload = () => {
            ctx?.drawImage(img, 0, 0)
            resolve()
          }
        })
      }

      function getImage(reset = false) {
        if (reset) { ctx.drawImage(img, 0, 0) }
        const imageData = ctx.getImageData(
          0,
          0,
          img.width,
          img.height,
        )
        return Picture.From(imageData)
      }

      function drawImage(i) {
        ctx.putImageData(new ImageData(i.data, i.width), 0, 0)
      }

      document.getElementById('reset').addEventListener(
        'click',
        () => {
          drawImage(getImage(true))
        },
      )
      document.getElementById('grayscale').addEventListener(
        'click',
        () => {
          drawImage(
            getImage().monochromize(
              eval(
                document.getElementById('grayscaleArea').value,
              ),
            ),
          )
        },
      )
      document.getElementById('manipulate').addEventListener(
        'click',
        () => {
          drawImage(
            getImage().manipulateChannels(
              eval(
                document.getElementById('manipulateArea').value,
              ),
            ),
          )
        },
      )
      document.getElementById('group').addEventListener(
        'click',
        () => {
          drawImage(
            getImage().groupColors(
              eval(
                document.getElementById('groupArea').value,
              ),
            ),
          )
        },
      )
      document.getElementById('binary').addEventListener(
        'click',
        () => {
          drawImage(
            getImage(true).monochromize().binarizeColors(),
          )
        },
      )
      document.getElementById('binary2').addEventListener(
        'click',
        () => {
          drawImage(
            getImage().binarizeColors(),
          )
        },
      )
      document.getElementById('convolve').addEventListener(
        'click',
        () => {
          drawImage(
            Picture.convolve(
              getImage(),
              eval(
                document.getElementById('convolveArea').value,
              ),
              true,
            ),
          )
        },
      )
      document.getElementById('convolve2').addEventListener(
        'click',
        () => {
          drawImage(
            Picture.convolve(
              getImage(),
              eval(
                document.getElementById('convolveArea').value,
              ),
              false,
            ),
          )
        },
      )
    </script>
  </body>
</html>
